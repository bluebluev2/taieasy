# 台電送件小幫手 - 專案介紹與操作手冊

## 1. 專案概述

**台電送件小幫手** 是一個基於純前端技術（HTML5/JS）開發的單頁式網頁應用程式（SPA）。

本工具旨在解決台電路燈送件流程中的圖資整合痛點，能夠將台電提供的 **PDF 台帳圖資** 進行地理配準，疊加在 OpenStreetMap 上，並整合 **路燈點位資料** 與 **參考台帳 (G-Code)**，提供自動化分類、視覺化編輯、以及符合送件規範的表單與圖檔輸出功能。

### 核心價值
* **無後端**：無須架設伺服器，資料完全在瀏覽器端處理，確保資安與隱私。
* **自動化分類**：依據 G-Code 資料自動判斷案件類別（增設/器變/容變）。
* **圖層烙印**：獨家的 PDF 匯出技術，將紅圈、文字「烙印」在 PDF 上，避免跨裝置顯示錯誤。
* **所見即所得**：網頁上篩選什麼，PDF 就匯出什麼。

---

## 2. 系統介面與功能區塊 

系統採「全螢幕地圖 + 左側懸浮工具列」設計，工具列採用「電力工程儀表板」風格，依操作邏輯分為五大區塊：

### 1. 底圖設定 (台帳圖資 PDF)
* **功能**：載入台電 PDF 圖檔。
* **自動定位**：解析檔名（如 `G5050.pdf`）自動計算地理座標邊界。
* **手動微調**：提供視覺化的四角拖拉功能，可直觀調整 PDF 與地圖的疊合位置。
* **透明度與鎖定**：可調整底圖透明度，並提供「鎖定/解鎖」功能防止誤觸。

### 2. 參考 G-Code (綠點)
* **功能**：匯入台電既有的 G-Code 參考點。
* **視覺化**：在地圖上以「綠色圓點」顯示。
* **作用**：建立索引資料庫 (G-Code -> 燈種 G-W)，供路燈資料進行自動分類判斷。

### 3. 路燈資料 (OUTPUT.csv)
* **功能**：管理本案要送件的路燈點位。
* **視覺化**：
    * **藍點**：定位點 (可拖曳)。
    * **紅圈**：施工範圍示意 (半徑可調)。
    * **紅字**：路燈編號與容量 (自動跟隨)。
* **自動分類邏輯**：
    * **增設**：G-code 欄位為空。
    * **器變**：對應 G-code 的參考資料含「鈉光燈」。
    * **容變**：對應 G-code 的參考資料含「LED」。
    * **待確認**：有 G-code 但無參考資料。
* **手動新增**：支援直接在地圖中心新增點位並命名。
* **篩選檢視**：可過濾只顯示特定類別（如只看「器變」），此篩選會連動影響 PDF 匯出結果。

### 4. 手動繪圖
* **功能**：輔助標示工具。
* **工具**：圓形、線條、文字註記。
* **屬性**：可自訂顏色與字級大小。

### 5. 輸出與存檔
* **匯出圖層 PDF**：產出包含底圖與紅圈標示的 PDF 檔（支援篩選後結果）。
* **匯出登記單 (Excel)**：產出符合台電格式的 CSV 表格。
* **專案存取 (JSON)**：完整保存當前所有狀態（含邊界、路燈、參考點、繪圖），方便下次繼續編輯。

---

## 3. 操作流程說明

### 步驟一：載入底圖
1. 點擊「**1. 底圖設定**」區塊的 `選擇檔案`。
2. 選取台電 PDF 圖檔 (例如 `G5050.pdf`)。
3. 系統會顯示「✅ 自動白邊」或「精準」定位訊息。
4. 若位置有偏差，點擊 `🔓 解鎖`，地圖上的 PDF 會出現控制點，使用滑鼠拖曳角落微調，完成後點擊 `🔒 鎖定`。

### 步驟二：建立參考索引 (強烈建議)
1. 點擊「**2. 參考 G-Code**」區塊的 `選擇檔案`。
2. 匯入包含 G-code 資訊的 CSV 檔。
3. 地圖上會出現綠色參考點，系統後台自動建立對照表。

### 步驟三：編輯路燈資料
**方式 A：批次匯入**
1. 於「**3. 路燈資料匯入**」區塊選擇 CSV 檔案。
2. 系統自動生成藍點紅圈，並依據步驟二的資料自動判斷「增設/器變/容變」。

**方式 B：手動新增**
1. 將地圖中心移至目標位置。
2. 點擊 `➕ 新增` 按鈕。
3. 輸入路燈名稱/編號，即刻建立資料。

**方式 C：屬性編輯**
1. 點擊地圖上的「藍色定位點」。
2. 開啟懸浮面板，可修改：
    * **G-code**：修改後會即時重新判斷案件類別。
    * **容量**：變更前/後容量 (支援選單或手動輸入)。
    * **紅圈半徑**：拉動滑桿調整紅圈大小 (預設 7m)。
3. 按下 `確認更新` 完成修改。

### 步驟四：匯出成果
1. **篩選資料**：在下拉選單選擇要輸出的類別（例如選擇「器變」）。
2. **匯出登記單**：點擊 `📊 匯出篩選後登記單`。
    * *系統自動填入規則*：變更後燈別=LED、盞數=1。
    * *檔名範例*：`G5050_器變登記單_20260114.csv`。
3. **匯出 PDF**：點擊 `💾 匯出圖層 PDF (含篩選)`。
    * 系統會將目前畫面上的紅圈與文字，以向量方式「畫」進 PDF 中。

### 步驟五：專案備份
1. 點擊 `📂 儲存專案` 下載 JSON 檔。
2. 下次工作時，點擊 `📂 載入專案` 即可完全還原所有進度（包含參考綠點）。

---

## 4. 資料格式規範 (Data Specifications)

為了確保系統正常運作，CSV 檔案需符合以下欄位名稱（支援 UTF-8 或 Big5 編碼）：

### A. 路燈資料 CSV (Street Lights)
| 欄位名稱 | 說明 | 範例 |
| :--- | :--- | :--- |
| `name` | 路燈編號/名稱 | 0603974 |
| `x` | 經度 (TWD97/WGS84) | 120.61345 |
| `y` | 緯度 (TWD97/WGS84) | 24.17681 |
| `G-code_1st` | 推測 G-code | G5050AE48 |

### B. 參考點 CSV (Reference Markers)
| 欄位名稱 | 說明 | 範例 |
| :--- | :--- | :--- |
| `G-code` | 台電圖號座標 | G5050AE48 |
| `G-x` | 經度 | 120.61345 |
| `G-y` | 緯度 | 24.17681 |
| `G-W` | 既有設備規格 | 鈉光燈 |

### C. 匯出登記單 CSV (Export Format)
系統固定產出以下欄位格式，可直接用 Excel 開啟：
`序號, 變更前電號, 變更後電號, 行政區, 裝設位置或地址, 裝設地點座標, 路燈編號(新), 變更前燈別, 變更前台帳容量, 變更前台帳盞數, 變更後燈別, 變更後容量(VA), 變更後盞數, 服務所, 受理號碼`

---

## 5. 技術堆疊 (Tech Stack for LLM Context)

若需請 AI 進行後續開發或修改，可提供以下技術背景：

* **核心語言**: HTML5, CSS3, JavaScript (ES6+, Vanilla JS)。
* **UI 風格**: Dark Dashboard Engineering Style (深色儀表板工程風格)。
* **地圖引擎**: Leaflet.js (v1.9.4)。
* **PDF 處理**:
    * `pdf.js`: 用於網頁 Canvas 渲染預覽。
    * `pdf-lib`: 用於產生最終 PDF 檔案 (使用 `drawCircle`, `drawImage` 進行向量繪製，非 Annotation)。
* **座標轉換**: Proj4js (處理 TWD67/97 轉 WGS84)。
* **CSV 解析**: PapaParse。
* **架構**: 單一 index.html 檔案，無後端資料庫 (Client-side)。
